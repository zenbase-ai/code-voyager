# Task 13 — Feedback-driven refinement (collection + attribution + insights)

## Goal

Implement the feedback loop from `docs/refinement.md`: capture tool outcomes via hooks, attribute them semantically to skills, and surface improvement insights.

## Deliverables

- `src/voyager/refinement/store.py`
  - SQLite-backed store for tool executions, attributions, and learned associations
  - default DB location for dogfooding: `./.claude/voyager/feedback.db` (fall back to a user-level path only if no project dir is available)
- `src/voyager/refinement/detector.py`
  - semantic skill attribution:
    1) transcript “skill read” detection (fast + accurate)
    2) learned associations (fast)
    3) ColBERT query via `find-skill` (optional)
    4) LLM inference fallback (bounded, timeout)
- Hook installer CLI:
  - `feedback-setup`
    - installs a `PostToolUse` hook script into `./.claude/hooks/` and updates *project-local* settings without overwriting existing hooks
    - supports a “dry-run/print” mode so dogfooding doesn’t accidentally modify user/global settings
- Hook script:
  - `.claude/hooks/post_tool_use.py` (installed/copied by `feedback-setup`)
    - logs minimal per-tool record
    - avoids heavy work in-hook; defers aggregation to `skill-insights`
- Insights CLI:
  - `skill-insights` aggregates:
    - error hotspots per skill
    - slow/failing workflows
    - top suggestions to refine SKILL.md or scripts
- Optional Claude skill wrapper:
  - `skills/skill-refinement/SKILL.md` describing how to run/interpret `skill-insights`

## Acceptance criteria

- PostToolUse hook stays fast and robust (never blocks dev loop).
- Attribution works without manual mappings; improves over time via learned associations.
- Insights output is actionable (points to concrete SKILL.md improvements or new skill candidates).
- Dogfood: include fixture PostToolUse events under `.claude/fixtures/hooks/` and verify this repo can:
  - log events into `./.claude/voyager/feedback.db`
  - attribute at least some events to one of the 5 skills (via transcript detection, retrieval, or LLM fallback)
  - produce a non-empty `skill-insights` report referencing this repo’s skills and files
- Dogfood: feed the insights back into this repo by updating at least one SKILL.md prompt/reference (or a script) based on observed failure modes.
